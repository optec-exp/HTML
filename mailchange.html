<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>邮箱变更依赖 - 更新 kintone 记录</title>
</head>
<body>

  <h1>邮箱变更依赖</h1>

  <!-- 表单：预填充案件番号和客人，并由用户填写新的邮箱 -->
  <form id="updateForm">
    <!-- 隐藏字段，用于存储记录ID -->
    <input type="hidden" id="recordId" name="recordId">

    <!-- 案件番号（预填充，设置为只读） -->
    <label for="案件番号">案件番号：</label>
    <input type="text" id="案件番号" name="案件番号" readonly><br><br>

    <!-- 客人（预填充，设置为只读） -->
    <label for="客人">客人：</label>
    <input type="text" id="客人" name="客人" readonly><br><br>

    <!-- 用户填写希望变更后的邮箱 -->
    <label for="newEmail">希望变更后的邮箱为（复数邮箱以半角逗号分隔）：</label>
    <input type="text" id="newEmail" name="newEmail" placeholder="例如：a@xx.com,b@xx.com" required><br><br>

    <button type="submit">提交更新</button>
  </form>

  <script>
    // 解析 URL 查询参数，返回一个键值对对象
    function getQueryParams() {
      const params = {};
      const queryString = window.location.search.substring(1);
      const queries = queryString.split('&');
      queries.forEach(function(query) {
        const [key, value] = query.split('=');
        if (key) {
          params[decodeURIComponent(key)] = decodeURIComponent(value || '');
        }
      });
      return params;
    }

    // 页面加载后，解析 URL 参数并将数据填入表单
    window.addEventListener('DOMContentLoaded', () => {
      const params = getQueryParams();
      // 填充记录ID、案件番号和客人字段
      if (params.recordId) {
        document.getElementById('recordId').value = params.recordId;
      }
      if (params.案件番号) {
        document.getElementById('案件番号').value = params.案件番号;
      }
      if (params.客人) {
        document.getElementById('客人').value = params.客人;
      }
    });

    // 监听表单提交事件，提交后调用 kintone API 更新记录
    document.getElementById('updateForm').addEventListener('submit', function(event) {
      event.preventDefault(); // 阻止默认提交

      // 获取表单中各字段的值
      const recordId = document.getElementById('recordId').value;
      const newEmail = document.getElementById('newEmail').value;

      // 构造 kintone 更新记录需要的数据对象
      const data = {
        app: 922,  // 请替换为你的 kintone 应用ID（数字）
        id: recordId,
        record: {
          // 假设 kintone 中用 mail 字段来保存邮箱数据
          "mail": { value: newEmail }
        }
      };

      // 发起 PUT 请求调用 kintone REST API 更新记录
      fetch("https://{subdomain}.cybozu.com/k/v1/record.json", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          // API Token，用于验证权限，请在 kintone 应用设置中生成并启用更新权限
          "X-Cybozu-API-Token": "KtHPEeEyRoFa5PcvEibNbTN5XfNBL1Pytkmw0q5e"
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        console.log("更新成功：", result);
        alert("记录已成功更新！");
      })
      .catch(error => {
        console.error("更新失败：", error);
        alert("更新记录时出错，请检查控制台日志。");
      });
    });
  </script>

</body>
</html>

